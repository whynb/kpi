<!DOCTYPE HTML>
<html lang="zh">
<head>
    {% include 'html/stitle.html' %}
    {% include 'html/scss.html' %}
    {% include 'html/sjs.html' %}
</head>

<style>
why-space {
  letter-spacing:12px
}
</style>

<body>
    <nav class="navbar navbar-default bootsnav" style="background-color: #e3f2fd;">
        <div class="container">
            {% include 'html/sheader.html' %}
            {% include 'html/smenu.html' %}
        </div>
    </nav>

    <div class="clearfix"></div>

    <!-- Start Content -->
    <div class="column">
        <div class="column-left">
            <div class="resize-bar"></div>
            <div class="resize-line"></div>
            <div class="resize-save">
                <div class="row sal_margin">
                    <h6 id="current_menu">组织结构</h6>
                    <div id="treeview-selectable" class=""></div>
                    <div id="selectable-output" hidden></div>
                </div>
            </div>
        </div>
        <div class="column-right">
            <div class="form-group form-inline" id="toolbar">
                {% include 'html/sdate.html' %}
                {% if editable[0] %}
                    <button id="create" class="btn btn-warning" onclick="button_create()"><i class="fa fa-plus"></i> 新建</button>
                {% endif %}

                {% if editable[1] %}
                    <button id="create" class="btn btn-danger" onclick="button_delete()"><i class="fa fa-remove"></i> 删除</button>
                {% endif %}

                {% if editable[5] %}
                    <button id="download" class="btn btn-success" onclick="button_download('{{ tips }}-'+getDateString(0)+'-'+getHourMinute(), 'excel')"><i class="fa fa-download"></i> 下载</button>
                {% endif %}

                {% if editable[4] %}
                    <button id="upload" class="btn btn-info" onclick="button_upload('上传{{ tips }}', '{{ menu }}')"><i class="fa fa-upload"></i> 上传</button>
                {% endif %}
            </div>
            <table id="table" class="table table-bordered table-striped"></table>
        </div>
    </div>
    <!-- End Content -->

    {% include 'html/sbuild.html' %}
    {% include 'html/sorgtree.html' %}

    {% if editable[4] %}
        {% include 'html/supload.html' %}
    {% endif %}

    {% if editable[5] %}
        {% include 'html/sdownload.html' %}
    {% endif %}

    {% if editable[1] %}
        {% include 'html/sdelete.html' %}
    {% endif %}


    <div class="modal fade" id="modal_create" tabindex="-1" role="dialog">
        <form class="form-horizontal" method="post" enctype="multipart/form-data" id="modal_create_form" onsubmit="modal_submit_create(this)">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="height:50px;">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h5 class="modal-title" id="modal_add_title"> 新建{{ tips }}</h5>
                    </div>
                    <div class="modal-body">

                        <div class="input-group input-group col-sm-12" style="width:500px;margin:10px 0px 0px 30px;">

                            <!-- TODO: FE select column from table by table-name -->
                            <!-- TODO: FE select static data from table by table-name -->
                            
                            <div class="form-group has-warning">
                                <label class="col-sm-5 control-label">Id: </label>
                                <div class="col-sm-7 ">
                                    <input type="text" name="CompanyId" id="txtCmpId" class="form-control" placeholder="Id">
                                </div>
                            </div>

                            <div class="form-group has-warning" hidden>
                                <input type="text" name="Slctcomtype" id="txtslctcomtype" class="form-control">
                            </div>
                            <div class="form-group has-warning">
                                <label class="col-sm-5 control-label">单位类型: </label>
                                <div class=" col-sm-7">
                                    <select class="selectpicker" data-width="200" title="选择单位类型" id="slctcomtype" onchange="stpcityChange()">
                                        <option value="-1">  全部类型</option>
                                        <option value="2">  类型</option>
                                    </select>
                                    <script>
                                        function stpcityChange(){ $('#txtslctcomtype').val($('#slctcomtype').val()); }
                                    </script>
                               </div>
                            </div>


                        </div>
                    </div>
                    <div class="modal-footer" id="modal_create_footer">
                        <div class="col-md-12">
                            <button id="modal_create_submit" type="button" class="btn btn-primary"><span class="fa fa-check"></span> 确定 </button>
                            <button id="modal_create_cancel" class="btn btn-danger" data-dismiss="modal"><span class="fa fa-close"></span> 取消 </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>

        function reset_create_form(){
            $('#modal_create_form')[0].reset();
            // TODO: check if all inputs reset or not; if not, add additional reset method per data type
        }

        function button_create(){
            reset_create_form();
            $('#modal_create').modal({backdrop: 'static', keyboard: false});
        }

        function modal_submit_create(obj) {
            var formData = new FormData(document.getElementById("modal_create_form"));
            $.ajax({
                type: 'POST',
                url: "{{ url('create_data') }}",
                headers: {"X-CSRFToken": getCookie('csrftoken')},
                data: formData,
                dataType: 'JSON',
                processData:false,   //  告诉jquery不要处理发送的数据
                contentType:false,   // 告诉jquery不要设置content-Type请求头
                success: function (data) {
                    if (data.success == true) {
                        $.hulla.send('成功新建数据！', "success");
                        $('#modal_create').modal('hide');
                        // refreshTable();
                        refresh();
                    }
                    else $.hulla.send('新建数据失败，请联系管理员！', "danger");
                },
                error: function (req, status, err) {
                    $.hulla.send('新建数据异常，请联系管理员！', "danger");
                    // $('#modal_create').modal('hide');
                }
            });
        }

        $(function() {
            $("#modal_create_cancel").click(function () { $('#modal_create').modal('hide'); });
            $("#modal_create_submit").click(function () { modal_submit_create(this); });
        });


    </script>



<script>
    var tree_url = "{{ url('get_allhrdpmt') }}";
    var tree_data_method = "{{ with_users }}";
    var $orgid = "";

    var $selected_node = {
        'type': 'd',
        'href': '',
        'code': getCookie('DWH'),
        'text': ''
    };

    function resetSelectedNode() {
        $selected_node = {
            'type': 'd',
            'href': '',
            'code': getCookie('DWH'),
            'text': ''
        };
    }

    function unselectNode(node) { $orgid = ''; resetSelectedNode(); refreshTable(); }

    function selectNode(node) { $selected_node = node; $orgid = $selected_node.href; refreshTable(); }

    function refresh() {
        if ($('#selectStartDate').val() > $('#selectEndDate').val()) {
            $.hulla.send('起始时间应小于等于终止时间，请重新选择！', "danger");
            return;
        }
        $selectableTree = initSelectableTree();
        // $('#table').bootstrapTable('destroy');
        refreshTable();
    }

    function getSelections() {
        var select = $("#table").bootstrapTable('getSelections');
        if (select.length <= 0) {
            $.hulla.send('请选择有效数据！', "danger");
            return [];
        }
        var res = [];
        for (var i=0; i<select.length; i++)
            res.push(select[i]);
        return res;
    }

    $(function() {

    });

</script>

</body>
</html>
