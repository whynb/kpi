
<style type="text/css">table {table-layout:auto;} th, td{word-break:keep-all;}  .fixed-table-container thead th .th-inner{ white-space:nowrap; }
</style>

<script type="text/javascript">
    var columns = [];
    var items = [];
    var table_titles = [];
    var itemCode = [];

    function align(columns) {
        for (var i=0; i < columns.length; i++) {
            columns[i].align = 'center';
            columns[i].halign= 'center';
            columns[i].valign = "middle";

            if (columns[i].field == 'note') columns[i].width = '100px';
        }
        return columns;
    }

    function YearFormatter(value, row, index) {
        if (value == null || value == undefined || value.length < 10) return value;
        return value.substring(0, 4);
    }

    function MonthFormatter(value, row, index) {
        if (value == null || value == undefined || value.length < 10) return value;
        return value.substring(0, 7);
    }

    function DateFormatter(value, row, index) {
        if (value == null || value == undefined || value.length < 10) return value;
        return value.substring(0, 10);
    }

    function build_title(items) {
        {% if sum_footer %}
        columns = [{ checkbox: true, footerFormatter: '合计', }];
        {% else %}
        columns = [{ checkbox: true, }];
        {% endif %}
        var col = {};
        var source = [];

        {% for title in title_columns %}
            col = {
                title: "{{ title['title'] }}",
                field: "{{ title['field'] }}",
                type: "{{ title['type'] }}",
                sortable : true,
            };
            {% if editable[2] %}
            {% if title['editable'] in ['True', 'true', 't', 'T'] %}
                {% if title['type'] in ['static', 'table'] %}
                    source = [];
                    {% with fields = static_fields(title['value']) %}
                        {% for val in static_func(payroll, title['value'], title['where']) %}
                            source.push( {value: "{{ val[fields[1]] }}", text: "{{ val[fields[1]] }}"} );
                        {% endfor %}
                    {% endwith %}
                    col = {
                        title: "{{ title['title'] }}", field: "{{ title['field'] }}", sortable : true,
                        type: "{{ title['type'] }}",
                        editable: {
                            emptytext: '--',
                            type: "select",
                            source: source,  // NOTE: source can be a function, but not sure can get from BE
                            validate: function (v) { if($.trim(v) == '') return '请重新选择！'; },
                        },
                    };
                {% endif %}
                {% if title['type'] in ['inline'] %}
                    source = [];
                    {% with fields = static_fields(title['value']) %}
                        {% for val in static_func(payroll, title['value'], title['where']) %}
                            source.push( {value: "{{ val[fields[0]] }}", text: "{{ val[fields[1]] }}"} );
                        {% endfor %}
                    {% endwith %}
                    col = {
                        title: "{{ title['title'] }}", field: "{{ title['field'] }}", sortable : true,
                        type: "{{ title['type'] }}",
                        editable: {
                            emptytext: '--',
                            type: "select",
                            source: source,  // NOTE: source can be a function, but not sure can get from BE
                            validate: function (v) { if($.trim(v) == '') return '请重新选择！'; },
                        },
                    };
                {% endif %}
                {% if title['type'] in ['text', 'textarea', 'float', 'year', 'month', 'date'] %}
                    col = {
                        title: "{{ title['title'] }}", field: "{{ title['field'] }}", sortable : true,
                        type: "{{ title['type'] }}",
                        editable: {
                            type: "text",
                            emptytext: "请输入",
                            validate: function (v) { if($.trim(v) == '') return '请重新输入！'; },
                        },
                    };
                {% endif %}
                {% if title['type'] in ['enum'] %}
                    source = [];
                    {% for val in title['value'] %}
                        source.push( {value: "{{ val }}", text: "{{ val }}"} );
                    {% endfor %}
                    col = {
                        title: "{{ title['title'] }}", field: "{{ title['field'] }}", sortable : true,
                        type: "{{ title['type'] }}",
                        editable: {
                            emptytext: '--',
                            type: "select",
                            source: source,
                            validate: function (v) { if($.trim(v) == '') return '请重新选择！'; },
                        },
                    };
                {% endif %}
                {% if title['type'] in ['class'] %}
                    {% if menu in ['jxkhgz'] %}
                    source = [];
                    {% for val in class_view %}
                        source.push( {value: "{{ val['class'] }}", text: "{{ val['name'] }}"} );
                    {% endfor %}
                    col = {
                        title: "{{ title['title'] }}", field: "{{ title['field'] }}", sortable : true,
                        type: "{{ title['type'] }}",
                        editable: {
                            emptytext: '',
                            type: "select",
                            source: source,
                            validate: function (v) { if($.trim(v) == '') return '请重新选择！'; },
                        },
                    };
                    {% endif %}
                {% endif %}
            {% endif %}
            {% endif %}

            {% if title['type'] in ['date'] %}
                col.formatter = DateFormatter;
            {% endif %}
            {% if title['type'] in ['year'] %}
                col.formatter = YearFormatter;
            {% endif %}
            {% if title['type'] in ['month'] %}
                col.formatter = MonthFormatter;
            {% endif %}

            {% if sum_footer %}
            col.footerFormatter = '';
            if (col.type == 'float') {
                col.footerFormatter = new Function(
                    "return function(rows) { var sum=0; for (var j=0; j<rows.length; j++) { sum += parseFloat(rows[j]."
                    + col.field + "); } return sum.toFixed(2); };"
                )();
            }
            if (col.type == 'number') {
                col.footerFormatter = new Function(
                    "return function(rows) { var sum=0; for (var j=0; j<rows.length; j++) { sum += parseFloat(rows[j]."
                    + col.field + "); } return sum.toFixed(0); };"
                )();
            }
            {% endif %}

            columns.push(col);
        {% endfor %}

        console.log(columns);
        columns = align(columns);
    }

    function build_table() {
        $('#table').bootstrapTable('destroy').bootstrapTable({
            url: '/jx/get_data',               //请求后台的URL（*）
            method: 'get',                      //请求方式（*）
            toolbar: '#toolbar',                //工具按钮用哪个容器
            striped: true,                      //是否显示行间隔色
            singleSelect: false,
            locale: 'zh-CN',
            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true,                   //是否显示分页（*）

            {% if sum_footer %}
            showFooter: true,
            {% endif %}

            queryParams: function (params) {
                var sort = params['sort'];
                if (sort == undefined) sort = "";
                var temp = {               // 这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                    limit: params.limit,   // 页面大小
                    offset: params.offset, // 页码
                    sort: sort,
                    order: params.order,
                    search: params.search,
                    code:  $selected_node.code,
                    type:  $selected_node.type,

                    item: array_to_string(itemCode),

                    start: $('#selectStartDate').val(),
                    end: $('#selectEndDate').val(),
                    menu: "{{ menu }}"
                };
                return temp;
            }, //传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageSize: 25,                       //每页的记录行数（*）
            pageList: [10, 25, 50, 'all'],        //可供选择的每页的行数（*）
            showExport: false,                   //是否显示导出按钮
            exportDataType: "all",              //basic', 'all', 'selected'.
            buttonsAlign: "right",              //按钮位置
            exportTypes: ['csv', 'excel'],             //导出文件类型
            exportOptions: { ignoreColumn: [0], fileName: '{{ tips }}'},  //文件名称设置 NOT work at x-editable
            search: true,                       //是否显示表格搜索，根据表格类型进行客户端搜索或者服务端搜索
            searchOnEnterKey: true,
            showRefresh: true,                  //是否显示刷新按钮
            showColumns: false,                 //是否显示所有的列
            clickToSelect: true,                //是否启用点击选中行
            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
            idField: "id",                      //used by x-editable
            undefinedText: '',
            onPostBody: function() {
                $('.search .search-input').attr('placeholder', '搜索带颜色列内容');
            },
            onLoadSuccess: function (data) {
                let h = $(".column-right").height(); if (h < 500) h = 500; $(".column-left").height(h);
                $('.fixed-table-loading.table.table-bordered.table-hover').hide();

                let x = document.getElementsByTagName("th");
                for (let i = 0; i < x.length; i++) {
                {% for column in search_columns %}
                    if (x[i].getAttribute("data-field") == '{{ column }}') {
                        x[i].firstChild.style.background = '#E0FFFF';
                    }
                {% endfor %}
                }
            },
            columns: columns,

            onEditableSave: function (field, row, oldValue, $el) {
                var data = row;
                data.field = field;
                data.menu = '{{ menu }}';
                $.ajax({
                    type: "post",
                    url: "{{ url('edit') }}",
                    headers: {"X-CSRFToken": getCookie('csrftoken')},
                    data: data,
                    dataType: 'JSON',
                    success: function (data, status) {
                        if (status == "success") { $.hulla.send(data.msg, "warning"); }
                        // refresh();
                        build_table();
                    },
                    error: function () { $.hulla.send('在线编辑异常，请重试！', "danger"); },
                    complete: function () {
                        // refreshTable();
                        refresh();
                    }
                });
            }

        });

        // by jinjia2 without http get
        {% for column in hide_columns %}
            $('#table').bootstrapTable('hideColumn', '{{ column }}');
        {% else %}
            $('#table').bootstrapTable('hideColumn', 'id');
            $('#table').bootstrapTable('hideColumn', 'stamp');
            $('#table').bootstrapTable('hideColumn', 'note');
        {% endfor %}
    }

    function initTable() {
        var queryParams = {
            limit: "1000",
            offset: "0",
            sort: "",
            order: "asc",
            search: "",
            code:  $selected_node.code,
            type:  $selected_node.type,

            item: array_to_string(itemCode),

            start: $('#selectStartDate').val(),
            end: $('#selectEndDate').val(),
            menu: "{{ menu }}"
        };

        $.ajax({
            type: "GET",
            url: "{{ url('get_title') }}",
            data: queryParams,
            dataType: 'json',
            success: function(data){
                table_titles = data;
                build_title(data);
                console.log(columns);
                build_table();
                post_build();
            },
            error: function(r, s, e) {
                $.hulla.send("获得{{ tips }}出错，请重试！", "danger");
            }
        });
    }

    function refreshTable() { 
        setTimeout(function () { 
            $('#table').bootstrapTable('refresh');
            post_build();
        }, 100); 
    }

    $(function() { setTimeout(function () { initTable(); }, 200); })

    function post_build() {}

</script>